<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wordcloud</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-scale.v3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3.layout.cloud.js"></script>
  </head>
  <body>
    <form>
      <label for="ftext">Article text:</label><br />
      <input
        type="text"
        id="ftext"
        name="ftext"
        value="Enter your article text here!"
      /><br />
      <button type="button" id="submitbutton">Submit text</button>
    </form>
    <p id="freetext"></p>
    <div id="my_dataviz"></div>
    <p id="similarity"></p>
    <script type="text/javascript">
      test2 = [
        { word: "look", count: 4151 },
        { word: "way", count: 8809 },
        { word: "officials", count: 3933 },
        { word: "family", count: 4765 },
        { word: "speech", count: 4039 },
        { word: "americans", count: 6780 },
        { word: "watch", count: 6602 },
        { word: "took", count: 4557 },
        { word: "donald", count: 17671 },
      ];
      // Maps for user input
      function wordCountMap(str) {
        let words = str.split(" ");
        let wordCount = {};
        words.forEach((w) => {
          wordCount[w] = (wordCount[w] || 0) + 1;
        });
        return wordCount;
      }
      // Converts format of wordcount list
      function countMap(wordcount) {
        let wordCountNew = {};
        wordcount.forEach((word) => {
          wordCountNew[word.word] = word.count;
        });
        return wordCountNew;
      }

      // Adds words in a countmap to a dictionary
      function wordsToDict(countMap, dictionary) {
        for (let key in countMap) {
          dictionary[key] = true;
        }
      }

      // Converts a countmap to a list of counts
      function countMapToVect(countmap, vocabdict) {
        let vect = [];
        for (let word in vocabdict) {
          vect.push(countmap[word] || 0);
        }
        return vect;
      }

      // Gets dot prod of two vecs
      function dotProd(vec1, vec2) {
        let sum = 0;
        for (let i = 0; i < vec1.length; i++) {
          sum += vec1[i] * vec2[i];
        }
        return sum;
      }

      // Gets magnitude of a vec
      function magnitude(vec) {
        let sum = 0;
        for (let i = 0; i < vec.length; i++) {
          sum += vec[i] * vec[i];
        }
        return Math.sqrt(sum);
      }

      // Get cosine sim of two vecs
      function cosSim(vec1, vec2) {
        return dotProd(vec1, vec2) / (magnitude(vec1) * magnitude(vec2));
      }

      // Puts everything together to get cosine sim of two wordcounts from DB
      function getSimilarity(wordcount1, wordcount2) {
        let counts1 = countMap(wordcount1);
        let counts2 = wordcount2;
        let dict = {};
        wordsToDict(counts1, dict);
        wordsToDict(counts2, dict);
        let vec1 = countMapToVect(counts1, dict);
        let vec2 = countMapToVect(counts2, dict);
        // vec1.forEach((element) => console.log(element));
        // console.log("vec1 len " + vec1.length);
        // console.log("dict len " + Object.keys(dict).length);
        // console.log("dot " + dotProd(vec1, vec2));
        // console.log("mag1 " + magnitude(vec1));
        // console.log("mag2 " + magnitude(vec2));
        return cosSim(vec1, vec2);
      }

      // Main function
      d3.json("http://ec2-100-27-46-58.compute-1.amazonaws.com/vocabs").then(
        function (data) {
          const counts = data[1][0].wordcounts;
          var similarity = 0;
          var ftext = document.getElementById("ftext").value;
          var user_counts = wordCountMap(ftext);

          //console.log(counts);
          //console.log(words2);
          //console.log(similarity);
          //console.log(user_counts);

          var words = counts.map(function (d) {
            return { text: d.word, size: d.count };
          });
          var words2 = [];
          Object.entries(user_counts).forEach(([k, v]) => {
            keyval = {};
            keyval["text"] = k;
            keyval["size"] = v;
            words2.push(keyval);
          });

          //console.log(words);
          //console.log(words2);

          var margin = { top: 10, right: 10, bottom: 10, left: 10 },
            width = 1000 - margin.left - margin.right,
            height = 1000 - margin.top - margin.bottom;

          // append the svg object to the body of the page
          var svg = d3
            .select("#my_dataviz")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr(
              "transform",
              "translate(" + margin.left + "," + margin.top + ")"
            );

          var svg2 = d3
            .select("#my_dataviz")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr(
              "transform",
              "translate(" + margin.left + "," + margin.top + ")"
            );

          // Function to draw both WCs
          function drawOne() {
            ftext = document.getElementById("ftext").value;
            user_counts = wordCountMap(ftext);
            //console.log(user_counts);
            similarity = Math.round(getSimilarity(counts, user_counts) * 100);

            //console.log(similarity);
            //console.log(words2);

            draw(words2);
          }

          d3.select("#submitbutton").on("click", drawOne);
          // Constructs a new cloud layout instance. It run an algorithm to find the position of words that suits your requirements
          var layout1 = d3.layout
            .cloud()
            .size([width, height])
            .words(words2)
            .padding(10)
            .fontSize(function (d) {
              return d.size * 40;
            })
            .rotate(0);
          layout1.start();
          var layout2 = d3.layout
            .cloud()
            .size([width, height])
            .words(words)
            .padding(10)
            .fontSize(function (d) {
              return d.size / 400;
            })
            .rotate(0)
            .on("end", draw2);
          layout2.start();

          // This function takes the output of 'layout' above and draw the words
          // Better not to touch it. To change parameters, play with the 'layout' variable above
          function draw(words2) {
            svg
              .append("g")
              .attr(
                "transform",
                "translate(" +
                  layout1.size()[0] / 2 +
                  "," +
                  layout1.size()[1] / 2 +
                  ")"
              )
              .selectAll("text")
              .data(words2)
              .enter()
              .append("text")
              .style("font-size", function (d) {
                return d.size + "px";
              })
              .attr("text-anchor", "middle")
              .attr("transform", function (d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
              })
              .attr("id", function (d) {
                return "id" + d.text;
              })
              .text(function (d) {
                return d.text;
              })
              .on("mouseover", function (d) {
                var id = "id" + d.text;
                // Select all with ID and make red
                d3.selectAll("#" + id).style("fill", "red");
                d3.selectAll("#" + id).style("cursor", "pointer");
              })
              .on("mouseout", function (d) {
                var id = "id" + d.text;
                // Return other to base colour
                d3.selectAll("#" + id).style("fill", "black");
              });
            // Write similarity
            document.getElementById("similarity").innerHTML =
              "Similarity: " + similarity + "%";
          }
          function draw2(words) {
            // Second WC
            svg2
              .append("g")
              .attr(
                "transform",
                "translate(" +
                  layout2.size()[0] / 2 +
                  "," +
                  layout2.size()[1] / 2 +
                  ")"
              )
              .selectAll("text")
              .data(words)
              .enter()
              .append("text")
              .style("font-size", function (d) {
                return d.size + "px";
              })
              .attr("text-anchor", "middle")
              .attr("transform", function (d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
              })
              .attr("id", function (d) {
                return "id" + d.text;
              })
              .text(function (d) {
                return d.text;
              })
              .on("mouseover", function (d) {
                var id = "id" + d.text;
                // Select and make red
                d3.selectAll("#" + id).style("fill", "red");
              })
              .on("mouseout", function (d) {
                var id = "id" + d.text;
                // Return to base colour
                d3.selectAll("#" + id).style("fill", "black");
              });
          }
        }
      );
    </script>
  </body>
</html>
