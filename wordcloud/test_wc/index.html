<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wordcloud</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-scale.v3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3.layout.cloud.js"></script>
  </head>
  <body>
    <form>
      <label for="ftext">Article text:</label><br />
      <input
        type="text"
        id="ftext"
        name="ftext"
        value="Enter your article text here!"
      /><br />
      <button type="button" id="submitbutton">Submit text</button>
    </form>
    <div id="my_dataviz"></div>
    <p id="similarity"></p>
    <script type="text/javascript">
      // Maps for user input
      function wordCountMap(str) {
        let words = str.replace(/[\p{P}$+<=>^`|~]/gu, "").split(" ");
        let wordCount = {};
        words.forEach((w) => {
          wordCount[w] = (wordCount[w] || 0) + 1;
        });
        return wordCount;
      }
      // Converts format of wordcount list
      function countMap(wordcount) {
        let wordCountNew = {};
        wordcount.forEach((word) => {
          wordCountNew[word.word] = word.count;
        });
        return wordCountNew;
      }

      // Adds words in a countmap to a dictionary
      function wordsToDict(countMap, dictionary) {
        for (let key in countMap) {
          dictionary[key] = true;
        }
      }

      // Converts a countmap to a list of counts
      function countMapToVect(countmap, vocabdict) {
        let vect = [];
        for (let word in vocabdict) {
          vect.push(countmap[word] || 0);
        }
        return vect;
      }

      // Gets dot prod of two vecs
      function dotProd(vec1, vec2) {
        let sum = 0;
        for (let i = 0; i < vec1.length; i++) {
          sum += vec1[i] * vec2[i];
        }
        return sum;
      }

      // Gets magnitude of a vec
      function magnitude(vec) {
        let sum = 0;
        for (let i = 0; i < vec.length; i++) {
          sum += vec[i] * vec[i];
        }
        return Math.sqrt(sum);
      }

      // Get cosine sim of two vecs
      function cosSim(vec1, vec2) {
        return dotProd(vec1, vec2) / (magnitude(vec1) * magnitude(vec2));
      }

      // Puts everything together to get cosine sim of two wordcounts from DB
      function getSimilarity(wordcount1, wordcount2) {
        let counts1 = countMap(wordcount1);
        let counts2 = wordcount2;
        let dict = {};
        wordsToDict(counts1, dict);
        wordsToDict(counts2, dict);
        let vec1 = countMapToVect(counts1, dict);
        let vec2 = countMapToVect(counts2, dict);
        // vec1.forEach((element) => console.log(element));
        // console.log("vec1 len " + vec1.length);
        // console.log("dict len " + Object.keys(dict).length);
        // console.log("dot " + dotProd(vec1, vec2));
        // console.log("mag1 " + magnitude(vec1));
        // console.log("mag2 " + magnitude(vec2));
        return cosSim(vec1, vec2);
      }

      function convertToFreq(wordcount) {
        var totalWords = 0;
        for (let i = 0; i < wordcount.length; i++) {
          totalWords += wordcount[i].count;
          //console.log(wordcount[i].count);
        }
        var freqVec = [];
        for (let i = 0; i < wordcount.length; i++) {
          wordFreq = {
            word: wordcount[i].word,
            count: wordcount[i].count / totalWords,
          };
          freqVec.push(wordFreq);
        }
        return freqVec;
      }

      function convertToFreq2(wordcount) {
        var totalWords = 0;
        Object.entries(wordcount).forEach(([k, v]) => (totalWords += v));
        var freqDict = {};
        Object.entries(wordcount).forEach(
          ([k, v]) => (freqDict[k] = v / totalWords)
        );
        return freqDict;
      }

      d3.select("#submitbutton").on("click", main_f);

      // Main function
      function main_f() {
        d3.json("http://ec2-100-27-46-58.compute-1.amazonaws.com/vocabs").then(
          function (data) {
            d3.selectAll("svg").remove();
            const counts = data[1][0].wordcounts;
            var similarity = 0;
            var ftext = document.getElementById("ftext").value;
            var user_counts = wordCountMap(ftext);

            var countsFreq = convertToFreq(counts);
            var userFreq = convertToFreq2(user_counts);

            //console.log(user_counts);
            //console.log(counts);
            //console.log(words2);
            //console.log(similarity);
            //console.log(user_counts);
            //console.log(countsFreq);

            var words = countsFreq.map(function (d) {
              return { text: d.word, size: d.count };
            });
            var words2 = [];
            Object.entries(userFreq).forEach(([k, v]) => {
              keyval = {};
              keyval["text"] = k;
              keyval["size"] = v;
              words2.push(keyval);
            });

            //console.log(words);
            //console.log(words2);

            var margin = { top: 10, right: 10, bottom: 10, left: 10 },
              width = 1000 - margin.left - margin.right,
              height = 1000 - margin.top - margin.bottom;

            // Adds SVGs
            var svg = d3
              .select("#my_dataviz")
              .append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("id", "maing")
              .attr(
                "transform",
                "translate(" + margin.left + "," + margin.top + ")"
              );

            var svg2 = d3
              .select("#my_dataviz")
              .append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr(
                "transform",
                "translate(" + margin.left + "," + margin.top + ")"
              );

            // Contructs layouts and decides where the words go
            var layout1 = d3.layout
              .cloud()
              .size([width, height])
              .words(words2)
              .padding(10)
              .fontSize(function (d) {
                return d.size * 400;
              })
              .rotate(0)
              .on("end", draw);
            layout1.start();
            var layout2 = d3.layout
              .cloud()
              .size([width, height])
              .words(words)
              .padding(10)
              .fontSize(function (d) {
                return d.size * 4000;
              })
              .rotate(0)
              .on("end", draw2);
            layout2.start();

            // Function to draw the clouds
            function draw(words2) {
              svg
                .append("g")
                .attr(
                  "transform",
                  "translate(" +
                    layout1.size()[0] / 2 +
                    "," +
                    layout1.size()[1] / 2 +
                    ")"
                )
                .selectAll("text")
                .data(words2)
                .enter()
                .append("text")
                .style("font-size", function (d) {
                  return d.size + "px";
                })
                .attr("text-anchor", "middle")
                .attr("transform", function (d) {
                  return (
                    "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")"
                  );
                })
                .attr("id", function (d) {
                  return "id" + d.text;
                })
                .text(function (d) {
                  return d.text;
                })
                .on("mouseover", function (d) {
                  var id = "id" + d.text;
                  // Select all with ID and make red
                  d3.selectAll("#" + id).style("fill", "red");
                  d3.selectAll("#" + id).style("cursor", "pointer");
                })
                .on("mouseout", function (d) {
                  var id = "id" + d.text;
                  // Return other to base colour
                  d3.selectAll("#" + id).style("fill", "black");
                });
            }
            function draw2(words) {
              // Second WC
              svg2
                .append("g")
                .attr(
                  "transform",
                  "translate(" +
                    layout2.size()[0] / 2 +
                    "," +
                    layout2.size()[1] / 2 +
                    ")"
                )
                .selectAll("text")
                .data(words)
                .enter()
                .append("text")
                .style("font-size", function (d) {
                  return d.size + "px";
                })
                .attr("text-anchor", "middle")
                .attr("transform", function (d) {
                  return (
                    "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")"
                  );
                })
                .attr("id", function (d) {
                  return "id" + d.text;
                })
                .text(function (d) {
                  return d.text;
                })
                .on("mouseover", function (d) {
                  var id = "id" + d.text;
                  // Select and make red
                  d3.selectAll("#" + id).style("fill", "red");
                })
                .on("mouseout", function (d) {
                  var id = "id" + d.text;
                  // Return to base colour
                  d3.selectAll("#" + id).style("fill", "black");
                });
            } // Write similarity
            similarity = Math.round(getSimilarity(countsFreq, userFreq) * 100);
            document.getElementById("similarity").innerHTML =
              "Similarity: " + similarity + "%";
          }
        );
      }
    </script>
  </body>
</html>
